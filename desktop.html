<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The OpenDesktop Project</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div id="desktop"></div>

<div id="taskbar-top">
    <div class="icon"></div>
    <div id="top-text">OpenDesktop Project</div>
    <div id="clock"></div>
</div>

<div id="taskbar-bottom">
    <div class="taskbar-left">
        <div id="start-menu" class="hidden">
            <div class="search-container">
                <input type="text" id="start-search" placeholder="Search applications..." onkeyup="filterApps()" autocomplete="off">
            </div>
            <div id="start-apps-list" class="start-menu-content">
                </div>
            <div class="start-menu-footer">
                <div class="power-buttons">
                    <button id="btn-sleep" onclick="sendToPython({action: 'power_command', command: 'sleep'})" title="Sleep">
                        <img src="assets/night.svg" alt="Sleep" class="btn-icon">
                    </button>
                    <button id="btn-restart" onclick="sendToPython({action: 'power_command', command: 'restart'})" title="Restart">↺</button>
                    <button id="btn-shutdown" onclick="sendToPython({action: 'power_command', command: 'shutdown'})" title="Shutdown" class="shutdown-btn">⏻</button>
                    <button id="btn-settings" onclick="sendToPython({action: 'open_bg_picker'})" title="Wallpaper" class="sleep-btn">
                        <img src="assets/set-wallpaper.svg" alt="Settings" class="btn-icon">
                    </button>
                </div>
            </div>
        </div>
        <div class="start-btn" onclick="toggleStartMenu()"></div>
    </div>

    <div class="taskbar-center" id="dock-container"></div>
    <div class="taskbar-right"></div>
</div>

<script>
/* --- STATE MANAGEMENT --- */
let pinnedApps = [];
let allApps = [];

/* --- UI LOGIC --- */
function updateClock() {
    const now = new Date();
    document.getElementById("clock").innerText =
        now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
}
setInterval(updateClock, 1000);
updateClock();

function toggleStartMenu() {
    const menu = document.getElementById('start-menu');
    const isHidden = menu.classList.toggle('hidden');
    
    // Search Bar Management
    if (!isHidden) {
        const searchInput = document.getElementById('start-search');
        searchInput.value = ""; 
        renderApps(allApps); // Reset list to show all
        setTimeout(() => searchInput.focus(), 50); 
    }
}

// Close menu when clicking desktop
document.getElementById('desktop').addEventListener('click', () => {
    document.getElementById('start-menu').classList.add('hidden');
});

// Prevent menu from closing when clicking inside it
document.getElementById('start-menu').addEventListener('click', (e) => e.stopPropagation());

/* --- SEARCH & APP RENDERING --- */
function filterApps() {
    const query = document.getElementById('start-search').value.toLowerCase();
    const filtered = allApps.filter(app => 
        app.name.toLowerCase().includes(query)
    );
    renderApps(filtered);
}

function renderApps(appsToDisplay) {
    const container = document.getElementById("start-apps-list");
    container.innerHTML = "";
    
    appsToDisplay.forEach(app => {
        const item = document.createElement("div");
        item.className = "start-app-item";
        item.innerHTML = `<img src="${app.icon}" onerror="this.src='assets/generic.png'"> <span>${app.name}</span>`;
        item.onclick = (e) => {
            e.stopPropagation();
            sendToPython({ action: "launch_app", command: app.exec });
            toggleStartMenu();
        };
        container.appendChild(item);
    });
}

/* --- COMMUNICATION BRIDGE --- */
function sendToPython(data) {
    if (window.webkit && window.webkit.messageHandlers.bridge) {
        window.webkit.messageHandlers.bridge.postMessage(JSON.stringify(data));
    }
}

// Called by Python to populate the Dock
function receiveDockData(apps) {
    pinnedApps = apps;
    updateRunningIndicators([]); 
}

// Called by Python to populate the Start Menu
function receiveStartMenuApps(apps) {
    allApps = apps;
    renderApps(allApps);
}

function updateRunningIndicators(runningWindows) {
    const container = document.getElementById("dock-container");
    container.innerHTML = "";

    // Render Pinned Apps
    pinnedApps.forEach(app => {
        const isRunning = runningWindows.some(w => app.exec.toLowerCase().includes(w.class));
        const appEl = document.createElement("div");
        appEl.className = `app ${isRunning ? "running" : ""}`;
        appEl.innerHTML = `<img src="${app.icon_path}" onerror="this.src='assets/generic.png'">`;
        
        appEl.onclick = () => {
            if (isRunning) {
                sendToPython({ action: "focus_app_by_command", command: app.exec });
            } else {
                sendToPython({ action: "launch_app", command: app.exec, file_path_based: app.FilePathBased || false });
            }
        };
        container.appendChild(appEl);
    });

    // Render Unpinned Running Apps
    runningWindows.forEach(win => {
        const isPinned = pinnedApps.some(p => p.exec.toLowerCase().includes(win.class));
        if (!isPinned) {
            const appEl = document.createElement("div");
            appEl.className = "app running unpinned";
            appEl.innerHTML = `<img src="${win.icon || ''}" onerror="this.src='assets/generic.png'">`;
            appEl.title = win.name;
            appEl.onclick = () => sendToPython({ action: "focus_app", xid: win.xid });
            container.appendChild(appEl);
        }
    });
}

function receivePowerIcons(icons) {
    if(icons.restart) document.getElementById('btn-restart').innerHTML = `<img src="${icons.restart}" style="width:20px; height:20px;">`;
    if(icons.shutdown) document.getElementById('btn-shutdown').innerHTML = `<img src="${icons.shutdown}" style="width:20px; height:20px;">`;
}

function applyBackground(path) {
    document.getElementById('desktop').style.backgroundImage = `url('${path}')`;
}

function receiveSavedBackground(path) { applyBackground(path); }

/* --- INIT --- */
window.onload = () => {
    sendToPython({ action: "get_dock_apps" });
    sendToPython({ action: "get_power_icons" });
    sendToPython({ action: "get_start_apps" });
    sendToPython({ action: "get_saved_background" });
};

/* --- PROTECTION --- */
['taskbar-top', 'taskbar-bottom'].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
        el.addEventListener('mousedown', e => { if(e.target.tagName !== 'INPUT') e.preventDefault(); });
        el.addEventListener('selectstart', e => { if(e.target.tagName !== 'INPUT') e.preventDefault(); });
    }
});
</script>
</body>
</html>